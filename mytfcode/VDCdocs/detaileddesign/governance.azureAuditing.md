## Auditing

An important part of governance is recording all actions that are done in an environment. Microsoft Azure records this data, but it is only retained for a short period of time with simple reporting. The Azure Cloud Framework architecture ensures that this data is exported to storage that provides better retention.

### Azure Activity Log

The Azure Activity Log records the following information for each subscription, which is retained by Azure for 90 days (not configurable):


| Category	| Description |
|-----------|-------------|
| Administrative |	Contains the record of all create, update, delete, and action operations performed through Resource Manager. Examples of Administrative events include create virtual machine and delete network security group. The activity log does not record application-layer activities or guest OS activities. That data must be recorded by the application or by the virtual machine (using monitoring extensions).|
| Service Health | Contains the record of any service health incidents that have occurred in Azure. An example of a Service Health event SQL Azure in East US is experiencing downtime. |
| Resource Health |	Contains the record of any resource health events that have occurred to your Azure resources. An example of a Resource Health event is Virtual Machine health status changed to unavailable. |
| Alert | Contains the record of activations for Azure alerts. An example of an Alert event is CPU % on myVM has been over 80 for the past 5 minutes. |
| Autoscale | Contains the record of any events related to the operation of the autoscale engine based on any autoscale settings you have defined in your subscription. An example of an Autoscale event is Autoscale scale up action failed. |
| Recommendation | Contains recommendation events from Azure Advisor.|
| Security | Contains the record of any alerts generated by Microsoft Defender for Cloud. An example of a Security event is Suspicious double extension file executed.|
| Policy | Contains records of all effect action operations performed by Azure Policy. Examples of Policy events include Audit and Deny. Every action taken by Policy is modeled as an operation on a resource.|

The Activity Log contains personailly identifiable information (PII) that is subject to the European Union GDPR. 

### Azure Active Directory

Azure Active directory records activity to several logs:

| Category | Description |
|----------|-------------|
|Sign-ins | Information about sign-ins and how your resources are used by your users.|
|Audit | Information about changes applied to your tenant such as users and group management or updates applied to your tenantâ€™s resources.|
|Provisioning | Activities performed by the provisioning service, such as the creation of a group in ServiceNow or a user imported from Workday.|

The retention policies for Azure AD logs are as follows:

|Report | Azure AD Free | Azure AD Premium P1 | Azure AD Premium P2|
|-------|---------------|---------------------|--------------------|
| Audit logs | Seven days | 30 days | 30 days |
| Sign-ins | Seven days | 30 days | 30 days |
| Azure AD MFA usage | 30 days | 30 days | 30 days |

The Azure AD logs contain personailly identifiable information (PII) that is subject to the European Union GDPR. 

### Extended Audit Log Retention

An organisation may require to retain audit logs for much longer periods than listed previously. The audit logs can be exported:

* For all Azure subscriptions
* For Azure AD 

::: Note
The **insights-logs-signinlogs** data will only be exported if an Azure Active Directory P1 or Azure Active Directory P2 license is present.
:::

There are two possible destinations for exported audit logs:

* Audit Storage Account as blob storage
* Log Analytics Workspace as table data

### Audit Storage Account As Blob Storage

Azure Activity Log and Azure Active Directory diagnostics data should stored in a storage account. The following containers should exist in this storage account:

* **insights-activity-logs**: Holds data from Azure Activity Log.
* **insights-logs-auditlogs**: Holds Audit data from Azure Active Directory.
* **insights-logs-signinlogs**: Holds Sign-in data from Azure Active Directory.
* **insights-logs-provisioninglogs**: Holds the Provision log data from Azure Active Directory

The Storage Account should be configured with a lifecycle management rule. This rule will move data, based on a configurable retention period. As an example, we typically recommend:

* To **cool storage** after **14 days**
* To **archive storage** after **32 days**
* **Delete** the data after **2563 days** (7 years)

*One year is treated as 366 days*

::: Note
The Delete setting is the retention policy. This value can be anything from 91 days to 99999 days (273 years).
:::

Each container should br configured with an access policy where Immutable blob storage has a Time-based retention of (Delete -1) days. Using the above example, it would be 2562 days. This prevents data from being deleted or modified.

The Storage Account is placed in a secured subscription where only a few approved personnel should have access to the data.

A Lock policy to prevent accidental deletion is also placed in the Storage Account.

::: Warning
The access policy must be set to reflect business requirements before it is locked. Downward changes (decreasing retention) may not be made. A limited number of upwards changes (increasing retention) may be made.
:::


#### Log Analytics Workspace As Table Data

The audit log data that is sent to the Storage Account can be held for many years in tamper-proof storage. However, the data held in blob storage is not useful for security or reporting purposes.

The audit log data is also valuable for security purposes - a Security Information & Event Management (SIEM) solution such as Microsoft Sentinel can use the data to find threats or to correlate activities when an alarm is raised. 

The second destination for audit log data should be a Log Analytics Workspace. Here, the data is stored in tables and can be queried, reported on, and used by other systems.

The Log Analytics Workspace will retain data for 365 days by default, but can be set to 30, 31, 60, 90, 120, 180, 270, 365, 550, or 730 days.

The Log Analytics Workspace is placed in a secured subscription where only a few approved personnel should have access to the Workspace - owners of the source resources have access to their own data in the Workspace through the user interface of their resources.

#### The GDPR

The GDPR has several requirements:

* **The data is kept for stated reasons only**: The organisation should inform users that IT and Cloud activity is logged for aduiting and security purposes.
* **The data is kept only as long as is needed**: The organisation should determine how long audit log data should be retained for. The retention of the Log Analytics Workspace can be configured to fit within this period (normally the default of 365 days is compliant) and the Lock and Delete features of the storage account should be configured accordingly.
* **The data is secure**: The data is deliberately placed in locations that should only be accessible by a few authorised persons.
